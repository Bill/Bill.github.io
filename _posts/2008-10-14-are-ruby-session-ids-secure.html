---
layout: post
title: Are Ruby Session ID’s Secure?
date: 2008-10-14 19:47:15.000000000 -07:00
type: post
published: true
status: publish
categories:
- Ruby
- Ruby on Rails
- security
tags: []
meta:
  _edit_last: '530919'
  _oembed_027b521d0b8b1ecdb3128f0d7de49175: "{{unknown}}"
author:
  login: bburcham
  email: bill.burcham@gmail.com
  display_name: Bill Burcham
  first_name: ''
  last_name: ''
---
<p>The question of the security of cookie-based session storage in Rails has pretty much been settled it seems to me. <a href="http://ryandaigle.com/articles/2007/2/21/what-s-new-in-edge-rails-cookie-based-sessions">Out of the box</a>, Rails uses cookie-based session storage. When you generate a new Rails app you get a nice new 128 character long (numbers and lowercase letters) secret set in config.action_controller.session[:secret] in your Rails::Initializer. That secret is used to sign and validate cookies for your application. Now the cookie data isn't secret mind you, but it is tamper-proof. Good.</p>
<p>Now what if you don't use cookie-based session storage at all? Well, just because you aren't using cookie-based session storage doesn't mean you aren't using cookies. If your application has sessions at all, be they memcached ones or ActiveRecord ones, it is probably using cookies. It's using cookies to <a href="http://www.quarkruby.com/2007/10/21/sessions-and-cookies-in-ruby-on-rails#sinrails">store the session id</a> so that when a request arrives, that id can be mapped to the corresponding session storage.</p>
<p>"So what" you say. "Well" I say… isn't it cool that Rails generates that big random secret for you when you use cookie-based session storage? When we are not using cookie-based session storage, and that secret is not generated, don't you wonder what secret is being used to secure your session id's? You see, a <a href="http://www.technicalinfo.net/papers/WebBasedSessionManagement.html">session id must be hard to guess</a> lest bad people <a href="http://www.cgisecurity.com/lib/SessionIDs.pdf">gain access to your site</a>. Usually when you want to make something hard to guess, you start with a secret and mix that with something that changes a lot and hash the whole shebang. So I went in search of this other secret.</p>
<p>What I found was that Rails calls <a href="http://corelib.rubyonrails.org/classes/CGI/Session.html#M000366">CGI::Session#create_new_id</a> to generate new session id's. That routine uses no secrete per se. It hashes (MD5) a combination of:</p>
<ol>
<li>the current date and time (expressed as a human-readable string)</li>
<li>the microseconds elapsed since the last second (expressed as a human-readable string)</li>
<li>a pseudo-random number greater than zero and less than one (from Kernel#rand)</li>
<li>the current process id number</li>
<li>the string 'foobar'</li>
</ol>
<p>Notice there is no secret keying material there. "But what about the Kernel#rand call Bill!" I hear you saying. If you go have a look at <a href="http://www.ruby-doc.org/core/classes/Kernel.html#M005977">Kernel#rand</a> and <a href="http://www.ruby-doc.org/core/classes/Kernel.html#M005976">Kernel#srand</a> you'll see that if rand is called before srand is called with a number parameter then the random number will be generated from a combination of:</p>
<ol>
<li>the current time</li>
<li>the process id number</li>
</ol>
<p>So the security of these session ids hinges on the secrecy of current time (on the server running Ruby) and the process id. Given that the system time is returned in HTTP headers and process id's are often in the hundreds or thousands, it's only really the microseconds that are hard to guess here, from a statistical standpoint. <a href="http://www.nycbsdcon.org/2006/files/BSDRailsBenninger.pdf">Others have expressed</a> similar concerns.</p>
<p>If you're worried about this two suggestions come to mind:</p>
<ul>
<li>time out sessions on the server so that an attacker has to guess faster</li>
<li>monkey-patch <a href="http://corelib.rubyonrails.org/classes/CGI/Session.html#M000366">CGI::Session#create_new_id</a> to hash its result with a great big old 128 character secret</li>
</ul>
<p><strong>Updated</strong>: October 15, 2008 expanded analysis of Kernel#rand and Kernel#srand and updated suggestions.</p>
